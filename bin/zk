#!/usr/bin/env bash

# checks that the current directory that user is in, is inside the $ZKSYNC_HOME.
# We depend on this variable in multiple places - so running from a different directory might have
# some surprising side effects (like loading wrong binaries etc).
check_subdirectory() {
    if [[ -z "$ZKSYNC_HOME" ]]; then
        echo -e "\e[31mError: ZKSYNC_HOME is not set.\e[0m"
        return 1
    fi

    ZKSYNC_HOME_ABS=$(realpath "$ZKSYNC_HOME")
    CURRENT_DIR_ABS=$(realpath .)

    if [[ "$CURRENT_DIR_ABS" != "$ZKSYNC_HOME_ABS"* ]]; then
        echo -e "\e[31mWarning: You are not in a subdirectory of ZKSYNC_HOME ($ZKSYNC_HOME_ABS).\e[0m"
        return 1
    fi
    return 0
}

# Currently many parts of our zk typescript are checked & verified with yarn v1.22.19 - and might fail with newer versions of yarn.
check_yarn_version() {
    desired_version="1.22.119"
    installed_version=$(yarn --version)

    if [ "$installed_version" != "$desired_version" ]; then
        echo -e "\e[31mWarning: Yarn is not at the desired version ($desired_version). Installed version is ($installed_version).\e[0m"
        echo -e "This might cause errors - we recommend to run:  \e[1m yarn set version $desired_version.\e[0m"
    fi
}

check_subdirectory
check_yarn_version
if [ -z "$1" ]; then
    cd $ZKSYNC_HOME
    yarn && yarn zk build
else
    # can't start this with yarn since it has quirks with `--` as an argument
    node -- $ZKSYNC_HOME/infrastructure/zk/build/index.js "$@"
fi
